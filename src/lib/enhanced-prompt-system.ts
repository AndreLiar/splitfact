// Enhanced Prompt System - Dynamic prompt generation with real-time fiscal data
// Creates contextually aware prompts for AI agents with current user data and regulations

import FiscalContextService, { UserFiscalProfile } from './fiscal-context';
import { SearchResult } from './web-search-service';
import { ExtractedContent } from './web-content-extractor';
import { NotionFiscalData } from './notion-service';

export interface PromptContext {
  userProfile: UserFiscalProfile;
  webSources?: SearchResult[];
  extractedContent?: ExtractedContent[];
  queryType: 'general' | 'compliance' | 'strategy' | 'calculation' | 'urgent' | 'research' | 'notion';
  specificContext?: {
    timeframe?: string;
    clientId?: string;
    projectName?: string;
    thresholdConcern?: boolean;
    complianceDeadline?: Date;
  };
}

export interface EnhancedPrompt {
  systemPrompt: string;
  contextualizedQuery: string;
  metadata: {
    dataFreshness: Date;
    includesWebData: boolean;
    includesNotionData: boolean;
    confidenceFactors: string[];
    riskAlerts: string[];
  };
}

export class EnhancedPromptSystem {
  
  /**
   * Generate contextually enhanced prompts for any query type
   */
  async generateEnhancedPrompt(
    originalQuery: string,
    context: PromptContext
  ): Promise<EnhancedPrompt> {
    // Build comprehensive system prompt
    const systemPrompt = this.buildSystemPrompt(context);
    
    // Create contextualized query with real-time data
    const contextualizedQuery = await this.buildContextualizedQuery(
      originalQuery,
      context
    );
    
    // Generate metadata for transparency and debugging
    const metadata = this.generatePromptMetadata(context);

    return {
      systemPrompt,
      contextualizedQuery,
      metadata
    };
  }

  /**
   * Build comprehensive system prompt based on context
   */
  private buildSystemPrompt(context: PromptContext): string {
    let systemPrompt = this.getBaseSystemPrompt(context.queryType);
    
    // Add user context awareness
    systemPrompt += this.addUserContextAwareness(context.userProfile);
    
    // Add web search capabilities if available
    if (context.webSources && context.webSources.length > 0) {
      systemPrompt += this.addWebSearchCapabilities();
    }
    
    // Add Notion integration awareness if available
    if (context.userProfile.notion.isConnected) {
      systemPrompt += this.addNotionIntegrationAwareness(context.userProfile.notion);
    }
    
    // Add specific instructions based on query type
    systemPrompt += this.addQueryTypeInstructions(context.queryType);
    
    // Add risk and compliance alerts
    systemPrompt += this.addRiskAndComplianceAlerts(context.userProfile);

    return systemPrompt;
  }

  /**
   * Build contextualized query with real-time fiscal data
   */
  private async buildContextualizedQuery(
    originalQuery: string,
    context: PromptContext
  ): Promise<string> {
    let enhancedQuery = originalQuery;
    
    // Add fiscal profile context
    enhancedQuery += '\n\n--- CONTEXTE FISCAL PERSONNEL ---\n';
    enhancedQuery += this.buildFiscalContextSection(context.userProfile);
    
    // Add web research data if available
    if (context.webSources && context.webSources.length > 0) {
      enhancedQuery += '\n\n--- INFORMATIONS WEB R√âCENTES ---\n';
      enhancedQuery += this.buildWebContextSection(context.webSources, context.extractedContent);
    }
    
    // Add Notion workspace data if available
    if (context.userProfile.notion.isConnected && context.userProfile.notion.fiscalData) {
      enhancedQuery += '\n\n--- DONN√âES NOTION WORKSPACE ---\n';
      enhancedQuery += this.buildNotionContextSection(context.userProfile.notion.fiscalData);
    }
    
    // Add specific context if provided
    if (context.specificContext) {
      enhancedQuery += '\n\n--- CONTEXTE SP√âCIFIQUE ---\n';
      enhancedQuery += this.buildSpecificContextSection(context.specificContext);
    }
    
    // Add current date and regulatory context
    enhancedQuery += `\n\n--- CONTEXTE TEMPOREL ---\n`;
    enhancedQuery += `Date actuelle: ${new Date().toLocaleDateString('fr-FR')}\n`;
    enhancedQuery += `Ann√©e fiscale: ${new Date().getFullYear()}\n`;
    enhancedQuery += `Trimestre: Q${Math.ceil((new Date().getMonth() + 1) / 3)}\n`;

    return enhancedQuery;
  }

  /**
   * Get base system prompt for query type
   */
  private getBaseSystemPrompt(queryType: string): string {
    const basePrompts = {
      general: `Tu es un CONSEILLER FISCAL EXPERT sp√©cialis√© en micro-entrepreneurs fran√ßais. Tu disposes d'un acc√®s complet aux donn√©es de l'utilisateur et aux informations fiscales les plus r√©centes.`,
      
      compliance: `Tu es un EXPERT EN CONFORMIT√â FISCALE sp√©cialis√© dans les obligations des micro-entrepreneurs. Tu as acc√®s aux derni√®res r√©glementations URSSAF et aux donn√©es personnelles de l'utilisateur.`,
      
      strategy: `Tu es un CONSULTANT STRAT√âGIQUE EN FISCALIT√â pour entrepreneurs fran√ßais. Tu combines l'analyse des donn√©es personnelles avec les opportunit√©s fiscales actuelles.`,
      
      calculation: `Tu es un EXPERT-COMPTABLE sp√©cialis√© en calculs fiscaux et sociaux pour micro-entrepreneurs. Tu as acc√®s aux donn√©es financi√®res pr√©cises de l'utilisateur.`,
      
      urgent: `Tu es un CONSEILLER FISCAL D'URGENCE. Cette demande n√©cessite une attention imm√©diate avec analyse des risques et actions correctives prioritaires.`,
      
      research: `Tu es un AGENT DE RECHERCHE FISCAL avec acc√®s aux informations web les plus r√©centes. Tu combines recherche r√©glementaire et contexte personnel de l'utilisateur.`,
      
      notion: `Tu es un ANALYSTE DE WORKSPACE NOTION sp√©cialis√© dans l'analyse crois√©e des donn√©es fiscales. Tu combines les donn√©es Notion avec le contexte Splitfact de l'utilisateur.`
    };

    return basePrompts[queryType as keyof typeof basePrompts] || basePrompts.general;
  }

  /**
   * Add user context awareness to system prompt
   */
  private addUserContextAwareness(userProfile: UserFiscalProfile): string {
    const currentYear = new Date().getFullYear();
    const thresholdProgress = userProfile.compliance.bncThresholdProgress;
    const revenue = userProfile.revenue.totalPaid;
    
    let context = `\n\nüîç **PROFIL UTILISATEUR ACTUEL:**\n`;
    context += `‚Ä¢ CA ${currentYear}: ${revenue.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}\n`;
    context += `‚Ä¢ Progression seuil BNC: ${thresholdProgress.toFixed(1)}% (${(thresholdProgress * 391).toFixed(0)}‚Ç¨ / 39 100‚Ç¨)\n`;
    context += `‚Ä¢ Clients actifs: ${userProfile.clients.total}\n`;
    
    if (userProfile.clients.averagePaymentDelay > 45) {
      context += `‚Ä¢ ‚ö†Ô∏è ALERTE: D√©lai paiement moyen √©lev√© (${userProfile.clients.averagePaymentDelay.toFixed(0)} jours)\n`;
    }
    
    if (thresholdProgress > 85) {
      context += `‚Ä¢ üö® CRITIQUE: Proche du seuil BNC (${thresholdProgress.toFixed(1)}%)\n`;
    } else if (thresholdProgress > 70) {
      context += `‚Ä¢ ‚ö†Ô∏è VIGILANCE: Surveillance seuil BNC n√©cessaire\n`;
    }

    return context;
  }

  /**
   * Add web search capabilities to system prompt
   */
  private addWebSearchCapabilities(): string {
    return `\n\nüåê **CAPACIT√âS WEB RENFORC√âES:**\n` +
           `‚Ä¢ Acc√®s aux derni√®res r√©glementations URSSAF et fiscales\n` +
           `‚Ä¢ Informations en temps r√©el des sources officielles\n` +
           `‚Ä¢ Veille r√©glementaire active (service-public.fr, urssaf.fr, impots.gouv.fr)\n` +
           `‚Ä¢ Validation crois√©e des informations avec sources multiples\n`;
  }

  /**
   * Add Notion integration awareness
   */
  private addNotionIntegrationAwareness(notionContext: any): string {
    let context = `\n\nüìù **INT√âGRATION NOTION ACTIVE:**\n`;
    context += `‚Ä¢ Workspace: ${notionContext.workspaceName || 'Connect√©'}\n`;
    
    if (notionContext.lastSyncAt) {
      const daysSinceSync = Math.floor((Date.now() - new Date(notionContext.lastSyncAt).getTime()) / (1000 * 60 * 60 * 24));
      context += `‚Ä¢ Derni√®re sync: il y a ${daysSinceSync} jour${daysSinceSync > 1 ? 's' : ''}\n`;
    }
    
    context += `‚Ä¢ Donn√©es disponibles: revenus, clients, projets, notes fiscales, m√©triques\n`;
    context += `‚Ä¢ Analyse crois√©e Splitfact ‚Üî Notion activ√©e\n`;

    return context;
  }

  /**
   * Add query type specific instructions
   */
  private addQueryTypeInstructions(queryType: string): string {
    const instructions = {
      general: `\n\nüìã **INSTRUCTIONS SP√âCIFIQUES:**\n‚Ä¢ Adapte ta r√©ponse au profil exact de l'utilisateur\n‚Ä¢ Cite les montants et seuils personnalis√©s\n‚Ä¢ Propose des actions concr√®tes\n`,
      
      compliance: `\n\n‚öñÔ∏è **FOCUS CONFORMIT√â:**\n‚Ä¢ V√©rifie les obligations actuelles selon le CA\n‚Ä¢ Identifie les risques de non-conformit√©\n‚Ä¢ Propose un plan d'action avec √©ch√©ances\n`,
      
      strategy: `\n\nüí° **ANALYSE STRAT√âGIQUE:**\n‚Ä¢ √âvalue les opportunit√©s fiscales personnalis√©es\n‚Ä¢ Analyse l'impact des projets Notion sur la fiscalit√©\n‚Ä¢ Propose des optimisations selon la progression des seuils\n`,
      
      calculation: `\n\nüßÆ **CALCULS PR√âCIS:**\n‚Ä¢ Utilise les montants exacts du profil utilisateur\n‚Ä¢ Calcule les impacts r√©els sur les seuils\n‚Ä¢ Fournis des projections chiffr√©es\n`,
      
      urgent: `\n\nüö® **MODE URGENCE:**\n‚Ä¢ Identifie les risques imm√©diats\n‚Ä¢ Propose des actions correctives prioritaires\n‚Ä¢ Mentionne les √©ch√©ances critiques\n`,
      
      research: `\n\nüîç **RECHERCHE AVANC√âE:**\n‚Ä¢ Combine informations web et contexte personnel\n‚Ä¢ Cite tes sources officielles\n‚Ä¢ Signale les nouveaut√©s r√©glementaires\n`,
      
      notion: `\n\nüìä **ANALYSE NOTION:**\n‚Ä¢ Compare les donn√©es Splitfact et Notion\n‚Ä¢ Identifie les opportunit√©s dans les projets\n‚Ä¢ Signale les incoh√©rences importantes\n`
    };

    return instructions[queryType as keyof typeof instructions] || instructions.general;
  }

  /**
   * Add risk and compliance alerts
   */
  private addRiskAndComplianceAlerts(userProfile: UserFiscalProfile): string {
    const alerts: string[] = [];
    const thresholdProgress = userProfile.compliance.bncThresholdProgress;
    const paymentDelay = userProfile.clients.averagePaymentDelay;
    
    if (thresholdProgress > 90) {
      alerts.push('üö® URGENCE: Risque de d√©passement seuil BNC imminent');
    } else if (thresholdProgress > 75) {
      alerts.push('‚ö†Ô∏è VIGILANCE: Surveillance seuil BNC requise');
    }
    
    if (paymentDelay > 60) {
      alerts.push('üí∞ ATTENTION: Retards de paiement importants d√©tect√©s');
    }
    
    if (userProfile.compliance.estimatedQuarterlyPayments > userProfile.revenue.totalPaid * 0.25) {
      alerts.push('üìä INFO: Charges sociales √©lev√©es ce trimestre');
    }

    if (alerts.length > 0) {
      return `\n\nüéØ **ALERTES CONTEXTUELLES:**\n${alerts.map(alert => `‚Ä¢ ${alert}`).join('\n')}\n`;
    }

    return '';
  }

  /**
   * Build fiscal context section
   */
  private buildFiscalContextSection(userProfile: UserFiscalProfile): string {
    const currentYear = new Date().getFullYear();
    let context = '';
    
    // Revenue analysis
    context += `üí∞ REVENUS ${currentYear}:\n`;
    context += `‚Ä¢ Encaiss√©: ${userProfile.revenue.totalPaid.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}\n`;
    context += `‚Ä¢ En attente: ${userProfile.revenue.totalPending.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}\n`;
    context += `‚Ä¢ En retard: ${userProfile.revenue.totalOverdue.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}\n`;
    
    if (userProfile.revenue.yearOverYear !== 0) {
      const trend = userProfile.revenue.yearOverYear > 0 ? 'üìà' : 'üìâ';
      context += `‚Ä¢ √âvolution vs N-1: ${trend} ${userProfile.revenue.yearOverYear > 0 ? '+' : ''}${userProfile.revenue.yearOverYear.toFixed(1)}%\n`;
    }
    
    // Compliance status
    context += `\n‚öñÔ∏è CONFORMIT√â:\n`;
    context += `‚Ä¢ Seuil BNC: ${userProfile.compliance.bncThresholdProgress.toFixed(1)}% (${(userProfile.compliance.bncThresholdProgress * 391).toFixed(0)}‚Ç¨ / 39 100‚Ç¨)\n`;
    context += `‚Ä¢ Seuil BIC: ${userProfile.compliance.bicThresholdProgress.toFixed(1)}% (${(userProfile.compliance.bicThresholdProgress * 919).toFixed(0)}‚Ç¨ / 91 900‚Ç¨)\n`;
    
    // Client analysis
    context += `\nüë• CLIENTS:\n`;
    context += `‚Ä¢ Total actifs: ${userProfile.clients.total}\n`;
    context += `‚Ä¢ D√©lai paiement moyen: ${userProfile.clients.averagePaymentDelay.toFixed(0)} jours\n`;
    
    if (userProfile.clients.topClients.length > 0) {
      const topClient = userProfile.clients.topClients[0];
      context += `‚Ä¢ Principal client: ${topClient.name} (${topClient.totalRevenue.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })})\n`;
    }

    return context;
  }

  /**
   * Build web context section from search results
   */
  private buildWebContextSection(
    sources: SearchResult[],
    extractedContent?: ExtractedContent[]
  ): string {
    let context = '';
    
    // Sources overview
    context += `üîç SOURCES CONSULT√âES (${sources.length}):\n`;
    sources.forEach((source, index) => {
      const trustIndicator = source.trustScore > 0.8 ? 'üü¢' : source.trustScore > 0.6 ? 'üü°' : 'üî¥';
      context += `${index + 1}. ${trustIndicator} ${source.title} (${source.domain})\n`;
    });
    
    // Key findings from extracted content
    if (extractedContent && extractedContent.length > 0) {
      context += `\nüìã POINTS CL√âS EXTRAITS:\n`;
      extractedContent.forEach((content, index) => {
        if (content.keyPoints.length > 0) {
          content.keyPoints.slice(0, 3).forEach(point => {
            context += `‚Ä¢ ${point}\n`;
          });
        }
      });
    }

    return context;
  }

  /**
   * Build Notion context section
   */
  private buildNotionContextSection(notionData: NotionFiscalData): string {
    let context = '';
    
    // Revenue comparison
    const notionRevenue = notionData.revenues.reduce((sum, r) => sum + r.amount, 0);
    context += `üíº DONN√âES NOTION:\n`;
    context += `‚Ä¢ Revenus trac√©s: ${notionRevenue.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}\n`;
    context += `‚Ä¢ Clients avec projets: ${notionData.clients.filter(c => c.projects.length > 0).length}\n`;
    context += `‚Ä¢ Notes fiscales: ${notionData.fiscalNotes.length} (${notionData.fiscalNotes.filter(n => n.priority === 'urgent').length} urgentes)\n`;
    context += `‚Ä¢ M√©triques business: ${notionData.businessMetrics.length}\n`;
    
    // Project pipeline
    const totalProjects = notionData.clients.reduce((sum, c) => sum + c.projects.length, 0);
    if (totalProjects > 0) {
      context += `‚Ä¢ Pipeline: ${totalProjects} projets actifs\n`;
    }
    
    // Recent urgent notes
    const urgentNotes = notionData.fiscalNotes.filter(n => n.priority === 'urgent');
    if (urgentNotes.length > 0) {
      context += `\nüö® NOTES URGENTES:\n`;
      urgentNotes.slice(0, 3).forEach(note => {
        context += `‚Ä¢ ${note.title}\n`;
      });
    }

    return context;
  }

  /**
   * Build specific context section
   */
  private buildSpecificContextSection(specificContext: any): string {
    let context = '';
    
    if (specificContext.timeframe) {
      context += `‚Ä¢ P√©riode d'analyse: ${specificContext.timeframe}\n`;
    }
    
    if (specificContext.clientId) {
      context += `‚Ä¢ Focus client: ${specificContext.clientId}\n`;
    }
    
    if (specificContext.projectName) {
      context += `‚Ä¢ Projet concern√©: ${specificContext.projectName}\n`;
    }
    
    if (specificContext.thresholdConcern) {
      context += `‚Ä¢ ‚ö†Ô∏è Pr√©occupation seuils fiscaux mentionn√©e\n`;
    }
    
    if (specificContext.complianceDeadline) {
      const deadline = new Date(specificContext.complianceDeadline);
      const daysUntil = Math.ceil((deadline.getTime() - Date.now()) / (1000 * 60 * 60 * 24));
      context += `‚Ä¢ üìÖ √âch√©ance: ${deadline.toLocaleDateString('fr-FR')} (dans ${daysUntil} jours)\n`;
    }

    return context;
  }

  /**
   * Generate prompt metadata
   */
  private generatePromptMetadata(context: PromptContext): EnhancedPrompt['metadata'] {
    const confidenceFactors: string[] = [];
    const riskAlerts: string[] = [];
    
    // Data freshness
    confidenceFactors.push(`Donn√©es utilisateur: ${new Date().toLocaleDateString('fr-FR')}`);
    
    // Web data availability
    if (context.webSources && context.webSources.length > 0) {
      confidenceFactors.push(`${context.webSources.length} sources web consult√©es`);
      const officialSources = context.webSources.filter(s => s.trustScore > 0.8).length;
      if (officialSources > 0) {
        confidenceFactors.push(`${officialSources} sources officielles valid√©es`);
      }
    }
    
    // Notion data integration
    if (context.userProfile.notion.isConnected) {
      confidenceFactors.push('Donn√©es Notion int√©gr√©es');
      if (context.userProfile.notion.lastSyncAt) {
        const daysSinceSync = Math.floor((Date.now() - new Date(context.userProfile.notion.lastSyncAt).getTime()) / (1000 * 60 * 60 * 24));
        if (daysSinceSync > 7) {
          riskAlerts.push(`Sync Notion ancienne (${daysSinceSync} jours)`);
        }
      }
    }
    
    // Risk detection
    if (context.userProfile.compliance.bncThresholdProgress > 85) {
      riskAlerts.push('Risque d√©passement seuil BNC');
    }
    
    if (context.userProfile.clients.averagePaymentDelay > 60) {
      riskAlerts.push('Retards de paiement importants');
    }

    return {
      dataFreshness: new Date(),
      includesWebData: !!(context.webSources && context.webSources.length > 0),
      includesNotionData: context.userProfile.notion.isConnected,
      confidenceFactors,
      riskAlerts
    };
  }

  /**
   * Create specialized prompts for different agent types
   */
  async createAgentSpecificPrompt(
    query: string,
    agentType: 'research' | 'notion' | 'general',
    userId: string,
    additionalContext?: any
  ): Promise<EnhancedPrompt> {
    // Get user fiscal profile
    const userProfile = await FiscalContextService.getUserFiscalProfile(userId);
    
    // Build context based on agent type
    const context: PromptContext = {
      userProfile,
      queryType: agentType,
      specificContext: additionalContext,
      ...(additionalContext?.webSources && { webSources: additionalContext.webSources }),
      ...(additionalContext?.extractedContent && { extractedContent: additionalContext.extractedContent })
    };
    
    return await this.generateEnhancedPrompt(query, context);
  }

  /**
   * Get prompt templates for common scenarios
   */
  getPromptTemplates(): Record<string, string> {
    return {
      thresholdAnalysis: "Analyse ma progression vers les seuils fiscaux et les impacts potentiels",
      clientAnalysis: "Analyse mes clients et identifie les risques et opportunit√©s",
      complianceCheck: "V√©rifie ma conformit√© fiscale et identifie les actions n√©cessaires",
      strategyOptimization: "Propose des optimisations fiscales adapt√©es √† ma situation",
      projectImpact: "Analyse l'impact fiscal de mes projets Notion sur ma situation",
      urgentAlert: "Identifie les actions fiscales urgentes √† prendre imm√©diatement"
    };
  }
}

// Singleton instance
let promptSystemInstance: EnhancedPromptSystem | null = null;

export const getEnhancedPromptSystem = (): EnhancedPromptSystem => {
  if (!promptSystemInstance) {
    promptSystemInstance = new EnhancedPromptSystem();
  }
  return promptSystemInstance;
};

export default EnhancedPromptSystem;